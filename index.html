<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Decomposer City</title>
<style>
body { font-family: sans-serif; background:#eef2f3; margin:0; }
header { background:#34495e; color:#fff; padding:10px; }
#info { display:flex; gap:20px; padding:10px; }
#grid { display:grid; grid-template-columns:repeat(6,80px); gap:6px; padding:10px; }
.cell {
  width:80px; height:80px; background:#fff;
  border-radius:10px; display:flex;
  flex-direction:column; align-items:center; justify-content:center;
  font-size:12px; cursor:pointer;
}
button { margin:3px; }
#log { height:140px; overflow:auto; background:#fff; padding:5px; }
.win { color:green; font-weight:bold; }
.lose { color:red; font-weight:bold; }
</style>
</head>
<body>

<header>
<h2>Decomposer City</h2>
<div>éƒ½å¸‚ã‚¿ã‚¤ãƒ—ï¼š<span id="cityType">æœªç™ºå±•</span></div>
</header>

<div id="info">
<div>
<h4>ã‚¿ãƒ</h4>
<button onclick="selectSeed('ä½å®…')">ä½å®…</button>
<button onclick="selectSeed('ç·‘åœ°')">ç·‘åœ°</button>
<button onclick="selectSeed('å•†æ¥­')">å•†æ¥­</button>
<button onclick="selectSeed('å·¥å ´')">å·¥å ´</button>
<div id="unlock"></div>
</div>

<div>
<h4>çŠ¶æ…‹</h4>
<div>ã‚¿ãƒ¼ãƒ³: <span id="turn">0</span></div>
<div>ç½å®³æœªå¯¾å‡¦: <span id="fail">0</span></div>
</div>
</div>

<div id="grid"></div>

<h4>ãƒ­ã‚°</h4>
<div id="log"></div>

<script>
const size = 6;
let grid = [];
let selected = "ä½å®…";
let turn = 0;
let fail = 0;
let unlocked = {};
let gameEnd = false;

const log = msg => {
  document.getElementById("log").innerHTML += msg+"<br>";
};

const gridDiv = document.getElementById("grid");

function init(){
  for(let i=0;i<size*size;i++){
    grid.push({type:"ç©º", lv:0, disabled:false});
  }
  draw();
}

function draw(){
  gridDiv.innerHTML="";
  grid.forEach((c,i)=>{
    const d=document.createElement("div");
    d.className="cell";
    d.innerHTML = c.type+"<br>Lv"+c.lv;
    d.onclick=()=>place(i);
    gridDiv.appendChild(d);
  });
}

function selectSeed(s){ selected=s; }

function place(i){
  if(gameEnd) return;
  const c=grid[i];
  if(c.disabled) return;

  if(c.type===selected){
    c.lv++;
  }else{
    c.type=selected;
    c.lv=1;
  }

  checkLocal(i);
  turn++;
  document.getElementById("turn").innerText=turn;
  disasterCheck();
  updateCityType();
  draw();
}

function checkLocal(i){
  const c=grid[i];
  if(c.type==="ä½å®…" && c.lv===3) c.type="é›†åˆä½å®…";
  if(c.type==="é›†åˆä½å®…" && c.lv===3) c.type="é«˜å¯†åº¦ä½å®…";
  if(c.type==="é«˜å¯†åº¦ä½å®…" && c.lv===3 && greenRate()<20){
    c.type="ã‚¹ãƒ©ãƒ ";
    log("ğŸš ã‚¹ãƒ©ãƒ ç™ºç”Ÿ");
  }
}

function greenRate(){
  return grid.filter(c=>c.type.includes("ç·‘")).length / grid.length *100;
}

function disasterCheck(){
  let rate=0.15;
  if(greenRate()<20) rate+=0.1;
  if(Math.random()<rate){
    triggerDisaster();
  }
}

function triggerDisaster(){
  const types=["è‡ªç„¶ç½å®³","ç–«ç—…","å‡¶ä½œ","å…¬å®³"];
  const d=types[Math.floor(Math.random()*types.length)];
  log("âš  ç½å®³ç™ºç”Ÿï¼š"+d);
  fail++;
  document.getElementById("fail").innerText=fail;

  if(d==="ç–«ç—…") unlock("ç—…é™¢");
  if(d==="å‡¶ä½œ") unlock("è¾²åœ°");
  if(d==="å…¬å®³") unlock("è¡Œæ”¿");

  if(d==="ç–«ç—…"){
    grid.forEach(c=>{
      if(c.type==="é«˜å¯†åº¦ä½å®…") c.type="ã‚¹ãƒ©ãƒ ";
    });
  }
  if(d==="å…¬å®³"){
    grid.forEach(c=>{
      if(c.type==="ç·‘åœ°") c.disabled=true;
    });
  }

  checkEnd();
}

function unlock(s){
  if(unlocked[s]) return;
  unlocked[s]=true;
  const b=document.createElement("button");
  b.innerText=s;
  b.onclick=()=>selectSeed(s);
  document.getElementById("unlock").appendChild(b);
  log("ğŸ”“ æ–°ã‚¿ãƒè§£æ”¾ï¼š"+s);
}

function updateCityType(){
  let type="æœªç™ºå±•";
  if(greenRate()>=40) type="ğŸŒ± ç’°å¢ƒå…ˆé€²éƒ½å¸‚";
  if(grid.filter(c=>c.type.includes("å•†æ¥­")).length>=5) type="ğŸ’° çµŒæ¸ˆéƒ½å¸‚";
  if(grid.some(c=>c.type==="åŒ»ç™‚ã‚»ãƒ³ã‚¿ãƒ¼")) type="ğŸ¥ å®‰å¿ƒéƒ½å¸‚";
  document.getElementById("cityType").innerText=type;
}

function checkEnd(){
  if(fail>=3){
    log("<span class='lose'>â˜  å´©å£Šéƒ½å¸‚ï¼ˆã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ï¼‰</span>");
    gameEnd=true;
  }
}

init();
</script>
</body>
</html>
