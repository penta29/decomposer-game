<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Planet Planter – Visual Complete</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
<style>
body{margin:0;background:#0b0f1a;color:#fff;font-family:sans-serif;}
</style>
</head>
<body>
<script>
/* ===== 設定 ===== */
const HEX=36, R=4;
let grid=[], seed="red";
let flashScreen=0;

/* ===== 色 ===== */
const COLORS={
 red:["#e74c3c","#c0392b","#ff7666"],
 green:["#2ecc71","#27ae60","#6bffb0"],
 blue:["#3498db","#2980b9","#6fbfff"],
 yellow:["#f1c40f","#d4ac0d","#ffe680"],
 park:["#7bed9f","#55c88a","#a8ffd8"],
 mixed:["#9b59b6","#7d3c98","#d2a6ff"],
 culture:["#f5f6fa","#dcdde1","#ffffff"]
};

/* ===== マス ===== */
class Hex{
 constructor(q,r){
  this.q=q; this.r=r;
  this.seed=null;
  this.exp=0;
  this.level=1;
  this.flash=0;
  this.hint=null;
 }
 neighbors(){
  const d=[[1,0],[0,1],[-1,1],[-1,0],[0,-1],[1,-1]];
  return d.map(v=>grid.find(h=>h.q==this.q+v[0]&&h.r==this.r+v[1])).filter(Boolean);
 }
 update(){
  if(!this.seed) return;
  let n=this.neighbors().map(h=>h.seed);
  this.exp+=0.01;
  if(n.includes("green")) this.exp+=0.02;

  let old=this.level;
  if(this.exp>3) this.level=3;
  else if(this.exp>1.5) this.level=2;

  if(old!=this.level) this.trigger();

  if(this.seed=="red" && n.includes("blue")) this.evolve("mixed");
  if(this.seed=="green" && n.includes("red")) this.evolve("park");
  if(["red","green","blue"].every(s=>n.includes(s))) this.evolve("culture");
 }
 evolve(s){
  if(this.seed==s) return;
  this.seed=s;
  this.trigger();
 }
 trigger(){
  this.flash=12;
  flashScreen=10;
 }
 danger(){
  if(this.seed=="yellow" && this.level==1) this.hint="工業が荒れてる";
  else if(this.seed=="red" && this.level==1) this.hint="暮らしが不安定";
  else if(this.exp>1.3 && this.level==1) this.hint="変化の予感";
 }
 draw(){
  let p=hexToPix(this.q,this.r);
  drawHex(p.x,p.y,this.seed);
  drawIcon(p.x,p.y,this.seed,this.level);

  if(this.flash>0){
    lightning(p.x,p.y);
    this.flash--;
  }
  if(this.hint) bubble(p.x,p.y-HEX,this.hint);
 }
}

/* ===== p5 ===== */
function setup(){
 createCanvas(windowWidth,windowHeight);
 for(let q=-R;q<=R;q++)for(let r=-R;r<=R;r++)
  if(abs(q+r)<=R) grid.push(new Hex(q,r));
}
function draw(){
 background(10,15,30);
 translate(width/2,height/2-40);

 grid.forEach(h=>{
  h.hint=null;
  h.update();
  h.danger();
  h.draw();
 });

 if(flashScreen>0){
  resetMatrix();
  fill(255,255,255,35);
  rect(0,0,width,height);
  flashScreen--;
 }

 resetMatrix();
 ui();
}

/* ===== 操作 ===== */
function mousePressed(){
 let h=pick(mouseX-width/2,mouseY-height/2+40);
 if(h && !h.seed){
  h.seed=seed;
  h.exp=0.3;
  h.trigger();
 }
}
function mouseClicked(){
 let x=width/2-140,y=height-60;
 ["red","green","blue","yellow"].forEach(s=>{
  if(mouseX>x&&mouseX<x+55&&mouseY>y&&mouseY<y+40) seed=s;
  x+=65;
 });
}

/* ===== UI ===== */
function ui(){
 let x=width/2-140,y=height-60;
 ["red","green","blue","yellow"].forEach(s=>{
  fill(COLORS[s][0]); rect(x,y,55,40,20);
  if(seed==s){stroke(255);noFill();rect(x-3,y-3,61,46,22);noStroke();}
  x+=65;
 });
}

/* ===== 描画 ===== */
function drawHex(x,y,s){
 if(!s){fill("#111");stroke(70);}
 else{
  stroke(COLORS[s][1]);
  fill(COLORS[s][0]);
 }
 poly(x,y,HEX,6);
 if(s){
  noStroke();
  fill(COLORS[s][2]+"55");
  poly(x,y-3,HEX-6,6);
 }
}
function drawIcon(x,y,s,l){
 noStroke();
 fill(255,180);
 if(s=="red"){ triangle(x-6,y+6,x,y-6,x+6,y+6); }
 if(s=="yellow"){ rect(x-4,y-6,8,12); rect(x+6,y-2,4,8); }
 if(s=="blue"){ rect(x-7,y-4,14,8); }
 if(s=="green"){ ellipse(x-4,y+2,6); ellipse(x+4,y+2,6); ellipse(x,y-4,6); }
 if(s=="park"){ ellipse(x,y,12); }
 if(s=="mixed"){ rect(x-6,y-6,12,12); }
 if(s=="culture"){ ellipse(x,y,14); }
 if(l>1){ fill(255); ellipse(x,y+10,3*l); }
}
function lightning(x,y){
 stroke(200,230,255,180);
 strokeWeight(2);
 let px=x,py=y;
 for(let i=0;i<5;i++){
  let nx=px+random(-10,10);
  let ny=py+random(-15,15);
  line(px,py,nx,ny);
  px=nx; py=ny;
 }
 noStroke();
}
function bubble(x,y,t){
 fill(255,230); noStroke();
 rect(x-55,y-26,110,22,12);
 fill(30); textSize(10); textAlign(CENTER,CENTER);
 text(t,x,y-15);
}
function poly(x,y,r,n){
 beginShape();
 for(let i=0;i<n;i++){
  let a=TWO_PI/n*i+PI/6;
  vertex(x+cos(a)*r,y+sin(a)*r);
 }
 endShape(CLOSE);
}
function hexToPix(q,r){
 return {x:HEX*sqrt(3)*(q+r/2),y:HEX*1.5*r};
}
function pick(x,y){
 let best=null,d=9999;
 grid.forEach(h=>{
  let p=hexToPix(h.q,h.r);
  let ds=dist(x,y,p.x,p.y);
  if(ds<d){d=ds;best=h;}
 });
 return d<HEX?best:null;
}
</script>
</body>
</html>
