<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Decompo City</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.min.js"></script>
<style>
  body { margin:0; overflow:hidden; font-family:sans-serif; background:#020508; color:#fff;}
  #p5-container { width:100%; height:100vh; }
</style>
</head>
<body>
<div id="p5-container"></div>
<script>
let decomposers = [];
let cityTiles = [];
let panelWidgets = ["House","Factory","Park"];
let activeWidgets = [];
let carbon = 0;
let mode = "normal";
let boostTimer = 0;
let disasterTimer = 0;

// --- Classes ---
class Decomposer {
  constructor() {
    this.pos = createVector(random(width*0.3, width), random(height));
    this.speed = 0.5;
  }
  update() {
    let spd = this.speed;
    if(mode=="boost") spd=2.5;
    if(mode=="danger") spd=0.2;
    this.pos.add(p5.Vector.random2D().mult(spd));
    this.pos.x = constrain(this.pos.x, width*0.3, width);
    this.pos.y = constrain(this.pos.y, 0, height);
  }
  display() {
    if(mode=="boost") fill(50,255,50);
    else if(mode=="danger") fill(255,50,50,180);
    else fill(100,200,100);
    noStroke();
    ellipse(this.pos.x,this.pos.y,6,6);
  }
}

class CityTile {
  constructor(x,y,type){
    this.pos = createVector(x,y);
    this.type = type;
    this.health = 100;
    this.size = 20;
  }
  update(){
    // 分解者が近くにいると健康回復
    let nearby = decomposers.filter(d=>p5.Vector.dist(d.pos,this.pos)<50);
    if(this.type=="Park") this.health += 0.1*nearby.length;
    else if(this.type=="Factory") this.health -= 0.05*nearby.length;
    this.health = constrain(this.health,0,100);

    // 街の状態でモード判定
    let avgHealth = cityTiles.reduce((sum,t)=>sum+t.health,0)/cityTiles.length;
    if(avgHealth<30) mode="danger";
  }
  display(){
    if(this.type=="House") fill(150,150,255,map(this.health,0,100,50,255));
    if(this.type=="Factory") fill(255,100,100,map(this.health,0,100,50,255));
    if(this.type=="Park") fill(100,255,100,map(this.health,0,100,50,255));
    rect(this.pos.x-this.size/2,this.pos.y-this.size/2,this.size,this.size);
  }
}

// --- Setup ---
function setup(){
  createCanvas(windowWidth,windowHeight).parent('p5-container');
  for(let i=0;i<30;i++) decomposers.push(new Decomposer());
  updateActiveWidgets();
}

// --- Draw ---
function draw(){
  background(2,5,10);

  // --- Update decomposers ---
  decomposers.forEach(d=>d.update());

  // --- Update city tiles ---
  cityTiles.forEach(t=>t.update());

  // --- Carbon & decomposer interaction ---
  cityTiles.forEach(tile=>{
    decomposers.forEach(d=>{
      let distTo = p5.Vector.dist(tile.pos,d.pos);
      if(distTo<30 && tile.type=="Park") carbon += 0.1;
    });
  });

  // --- Draw decomposers ---
  decomposers.forEach(d=>d.display());

  // --- Draw city ---
  cityTiles.forEach(t=>t.display());

  // --- Draw panel ---
  drawPanel();

  // --- Mode effects ---
  if(mode=="boost"){
    boostTimer--;
    if(boostTimer<=0) mode="normal";
    fill(50,255,50,50);
    ellipse(width/2,height/2,width,height);
  }
  if(mode=="danger"){
    fill(255,0,50,50);
    rect(width*0.3,0,width*0.7,height);
  }

  // --- Random disasters ---
  disasterTimer++;
  if(disasterTimer>600){
    triggerDisaster();
    disasterTimer=0;
  }

  // --- UI ---
  fill(255);
  textSize(18);
  text(`Carbon: ${carbon.toFixed(1)}  Mode: ${mode}`,20,30);
}

// --- Panel ---
function drawPanel(){
  fill(50);
  rect(0,0,width*0.3,height);
  textSize(16);
  fill(255);
  text("Widget Panel",10,30);
  activeWidgets.forEach((w,i)=>{
    fill(200);
    rect(10,50+i*40,120,30);
    fill(0);
    text(w,20,70+i*40);
  });
}

// --- Mouse ---
function mousePressed(){
  if(mouseX>width*0.3){
    // 置く位置
    if(activeWidgets.length>0){
      let w = activeWidgets[0]; // 選択は一番左
      cityTiles.push(new CityTile(mouseX,mouseY,w));
      updateActiveWidgets();
    }
  }
}

// --- Key ---
function keyPressed(){
  if(key==='B' || key==='b'){
    mode="boost";
    boostTimer=300;
  }
}

// --- Disaster ---
function triggerDisaster(){
  let type = random(["Storm","Fire","Flood"]);
  cityTiles.forEach(t=>{
    t.health -= random(10,30);
    t.health = max(t.health,0);
  });
}

// --- Update widgets based on decomposer state ---
function updateActiveWidgets(){
  let avgHealth = decomposers.reduce((sum,d)=>sum+1,0)/decomposers.length; // dummy: always >0
  // ここでは簡単に、ブーストならレア追加
  if(mode=="boost"){
    activeWidgets = ["House","Factory","Park","ScienceLab"];
  } else if(mode=="danger"){
    activeWidgets = ["House","Park"];
  } else {
    activeWidgets = ["House","Factory","Park"];
  }
}

// --- Window Resize ---
function windowResized(){
  resizeCanvas(windowWidth,windowHeight);
}
</script>
</body>
</html>
