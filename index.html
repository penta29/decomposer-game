<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Planet Planter – Refined Edition</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
<style>
body{margin:0;background:#0c1020;color:#fff;font-family:"Hiragino Sans",sans-serif;}
</style>
</head>
<body>
<script>
/* ===== 設定 ===== */
const HEX = 34;
const R = 6; // マス増加
let grid = [];
let selectedSeed = "red";
let flashScreen = 0;
let infoText = "";

/* ===== タネ定義 ===== */
const SEEDS = {
 red:{name:"住宅", desc:"人が住む場所。緑があると育つ。", base:"#c85a5a"},
 green:{name:"緑地", desc:"自然エリア。街を安定させる。", base:"#4fa37a"},
 blue:{name:"商業", desc:"お店やにぎわいを生む。", base:"#4a78a8"},
 yellow:{name:"工業", desc:"ものを作る。放置すると荒れる。", base:"#c2a14d"},
 park:{name:"公園", desc:"人と自然の休憩所。", base:"#6fbf9a"},
 mixed:{name:"複合施設", desc:"住む×働くが一体化。", base:"#8c6bb1"},
 culture:{name:"文化地区", desc:"街の中心。強い。", base:"#d0d3d8"}
};

/* ===== マス ===== */
class Hex{
 constructor(q,r){
  this.q=q; this.r=r;
  this.seed=null;
  this.exp=0;
  this.level=1;
  this.flash=false;
  this.hint=null;
 }
 neighbors(){
  const d=[[1,0],[0,1],[-1,1],[-1,0],[0,-1],[1,-1]];
  return d.map(v=>grid.find(h=>h.q==this.q+v[0]&&h.r==this.r+v[1])).filter(Boolean);
 }
 update(){
  if(!this.seed) return;

  let n = this.neighbors().map(h=>h.seed);
  this.exp += 0.005;
  if(n.includes("green")) this.exp += 0.01;

  let oldLevel = this.level;
  if(this.exp > 3) this.level = 3;
  else if(this.exp > 1.5) this.level = 2;

  if(this.level !== oldLevel){
    this.triggerFlash();
  }

  // 合わせ技
  if(this.seed==="red" && n.includes("blue")) this.evolve("mixed");
  if(this.seed==="green" && n.includes("red")) this.evolve("park");
  if(["red","green","blue"].every(s=>n.includes(s))) this.evolve("culture");
 }
 evolve(newSeed){
  if(this.seed === newSeed) return;
  this.seed = newSeed;
  this.triggerFlash();
 }
 triggerFlash(){
  this.flash = true;
  flashScreen = 6;
 }
 danger(){
  if(this.seed==="yellow" && this.level===1){
    this.hint="工業が不安定";
  } else if(this.exp>1.3 && this.level===1){
    this.hint="変化しそう";
  }
 }
 draw(){
  let p = hexToPix(this.q,this.r);
  drawHex(p.x,p.y,this.seed);
  drawIcon(p.x,p.y,this.seed,this.level);

  if(this.flash){
    lightning(p.x,p.y);
    this.flash=false;
  }
  if(this.hint){
    bubble(p.x,p.y-HEX,this.hint);
  }
 }
}

/* ===== p5 ===== */
function setup(){
 createCanvas(windowWidth,windowHeight);
 for(let q=-R;q<=R;q++){
  for(let r=-R;r<=R;r++){
   if(Math.abs(q+r)<=R) grid.push(new Hex(q,r));
  }
 }
 infoText = SEEDS[selectedSeed].desc;
}
function draw(){
 background(12,16,32);
 translate(width/2,height/2-40);

 grid.forEach(h=>{
  h.hint=null;
  h.update();
  h.danger();
  h.draw();
 });

 if(flashScreen>0){
  resetMatrix();
  fill(200,220,255,20);
  rect(0,0,width,height);
  flashScreen--;
 }

 resetMatrix();
 drawUI();
}

/* ===== 操作 ===== */
function mousePressed(){
 let h = pick(mouseX-width/2,mouseY-height/2+40);
 if(h && !h.seed){
  h.seed = selectedSeed;
  h.exp = 0.2;
 }
}
function mouseClicked(){
 let x=40,y=height-120;
 Object.keys(SEEDS).slice(0,4).forEach(k=>{
  if(mouseX>x && mouseX<x+60 && mouseY>y && mouseY<y+60){
   selectedSeed = k;
   infoText = SEEDS[k].desc;
  }
  x+=70;
 });
}

/* ===== UI ===== */
function drawUI(){
 // タネ選択
 let x=40,y=height-120;
 Object.keys(SEEDS).slice(0,4).forEach(k=>{
  fill(SEEDS[k].base);
  rect(x,y,60,60,18);
  if(selectedSeed===k){
   stroke(255);noFill();rect(x-3,y-3,66,66,20);noStroke();
  }
  x+=70;
 });

 // 説明
 fill(255,240);
 rect(40,40,260,70,20);
 fill(30);
 textSize(12);
 textAlign(LEFT,TOP);
 text(infoText,60,55);
}

/* ===== 描画補助 ===== */
function drawHex(x,y,s){
 if(!s){
  fill("#161a2e"); stroke(60);
 }else{
  let c=color(SEEDS[s].base);
  fill(red(c),green(c),blue(c),200);
  stroke(red(c)*0.8,green(c)*0.8,blue(c)*0.8);
 }
 poly(x,y,HEX,6);
}
function drawIcon(x,y,s,l){
 noStroke();
 fill(255,200);
 if(s==="red") triangle(x-6,y+6,x,y-6,x+6,y+6);
 if(s==="green") ellipse(x,y,10);
 if(s==="blue") rect(x-6,y-4,12,8,2);
 if(s==="yellow") rect(x-4,y-6,8,12);
 if(l>1) ellipse(x,y+10,3*l);
}
function lightning(x,y){
 stroke(200,220,255,160);
 strokeWeight(2);
 let px=x,py=y;
 for(let i=0;i<4;i++){
  let nx=px+random(-8,8);
  let ny=py+random(-12,12);
  line(px,py,nx,ny);
  px=nx; py=ny;
 }
 noStroke();
}
function bubble(x,y,t){
 fill(255,230);
 noStroke();
 rect(x-45,y-22,90,18,10);
 fill(40);
 textSize(9);
 textAlign(CENTER,CENTER);
 text(t,x,y-13);
}
function poly(x,y,r,n){
 beginShape();
 for(let i=0;i<n;i++){
  let a=TWO_PI/n*i+PI/6;
  vertex(x+cos(a)*r,y+sin(a)*r);
 }
 endShape(CLOSE);
}
function hexToPix(q,r){
 return {x:HEX*sqrt(3)*(q+r/2), y:HEX*1.5*r};
}
function pick(x,y){
 let best=null,d=9999;
 grid.forEach(h=>{
  let p=hexToPix(h.q,h.r);
  let ds=dist(x,y,p.x,p.y);
  if(ds<d){d=ds;best=h;}
 });
 return d<HEX?best:null;
}
</script>
</body>
</html>
